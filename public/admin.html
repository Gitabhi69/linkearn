<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkEarn - Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1a202c;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            position: fixed;
            height: 100vh;
            z-index: 50;
            overflow-y: auto;
        }
        
        .sidebar.active {
            transform: translateX(0);
        }
        
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
                position: static;
                height: auto;
            }
        }
        
        .sidebar-link {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .sidebar-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .sidebar-link:hover::before {
            left: 100%;
        }
        
        .sidebar-link:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transform: translateX(8px);
        }
        
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            margin-left: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 2rem 0 0 2rem;
            box-shadow: -10px 0 25px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        @media (min-width: 768px) {
            .main-content {
                margin-left: 280px;
            }
        }
        
        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }
        
        .stat-card {
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-primary:hover::before {
            left: 100%;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.3);
        }
        
        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
        }
        
        .input-field {
            width: 100%;
            padding: 1rem 1.25rem;
            margin-bottom: 1.5rem;
            border-radius: 1rem;
            border: 2px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            color: #1a202c;
            outline: none;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }
        
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 1.25rem;
            text-align: left;
            font-weight: 600;
            letter-spacing: 0.05em;
        }
        
        td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s ease;
        }
        
        tr:hover td {
            background-color: rgba(102, 126, 234, 0.05);
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            padding: 2rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        
        .modal.active .modal-content {
            transform: scale(1);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 1rem;
            color: white;
            font-weight: 600;
            z-index: 1100;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification.success {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .notification.error {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }
        
        .notification.info {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .hamburger {
            position: fixed;
            top: 1.5rem;
            left: 1.5rem;
            z-index: 60;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.75rem;
            border-radius: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .hamburger:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        @media (min-width: 768px) {
            .hamburger {
                display: none;
            }
        }
        
        .icon-gradient {
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="hamburger" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-2xl font-bold text-center bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                LinkEarn Admin
            </h2>
        </div>
        <nav class="p-4 flex flex-col space-y-2">
            <a href="#" class="sidebar-link active p-4 rounded-xl font-semibold transition-all duration-300" data-section="dashboard">
                <div class="flex items-center space-x-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                    <span>Dashboard</span>
                </div>
            </a>
            <a href="#" class="sidebar-link p-4 rounded-xl font-semibold transition-all duration-300" data-section="user-management">
                <div class="flex items-center space-x-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    <span>User Management</span>
                </div>
            </a>
            <a href="#" class="sidebar-link p-4 rounded-xl font-semibold transition-all duration-300" data-section="withdrawal-management">
                <div class="flex items-center space-x-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M12 1l7 6h-4v4H9V7H5l7-6z"></path>
                    </svg>
                    <span>Withdrawals</span>
                </div>
            </a>
            <a href="#" class="sidebar-link p-4 rounded-xl font-semibold transition-all duration-300" data-section="unique-codes">
                <div class="flex items-center space-x-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="16 18 22 12 16 6"></polyline>
                        <polyline points="8 6 2 12 8 18"></polyline>
                    </svg>
                    <span>Unique Codes</span>
                </div>
            </a>
            <a href="#" class="sidebar-link p-4 rounded-xl font-semibold transition-all duration-300" data-section="system-settings">
                <div class="flex items-center space-x-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1 1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                    <span>Settings</span>
                </div>
            </a>
            <a href="#" id="adminLogoutButton" class="sidebar-link p-4 rounded-xl font-semibold text-red-600 hover:text-white hover:bg-red-500 mt-auto transition-all duration-300">
                <div class="flex items-center space-x-3">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                    <span>Logout</span>
                </div>
            </a>
        </nav>
    </div>

    <div class="main-content" id="mainContent">
        <!-- Admin Login Form -->
        <div id="adminLogin" class="content-section active flex justify-center items-center min-h-screen">
            <div class="card max-w-md w-full">
                <div class="text-center mb-8">
                    <h2 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Admin Login
                    </h2>
                    <p class="text-gray-600">Sign in to access the admin panel</p>
                </div>
                <form id="adminLoginForm" class="space-y-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                        <input type="email" id="adminUsername" placeholder="Enter your email" class="input-field" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                        <input type="password" id="adminPassword" placeholder="Enter your password" class="input-field" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">
                        <span id="loginText">Sign In</span>
                        <span id="loginSpinner" class="loading-spinner hidden ml-2"></span>
                    </button>
                </form>
                <div id="adminLoginError" class="mt-4 p-3 bg-red-100 border border-red-400 text-red-700 rounded-lg hidden"></div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="content-section">
            <div class="mb-8">
                <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    Dashboard Overview
                </h1>
                <p class="text-gray-600">Monitor your platform's performance and key metrics</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card stat-card text-center">
                    <div class="mb-4">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-blue-500 to-purple-600 rounded-2xl flex items-center justify-center">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Total Users</h3>
                        <p class="text-4xl font-bold text-blue-600" id="totalUsers">0</p>
                    </div>
                </div>

                <div class="card stat-card text-center">
                    <div class="mb-4">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-green-500 to-teal-600 rounded-2xl flex items-center justify-center">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <polyline points="22 7 13.5 15.5 8.5 10.5 2 17"></polyline>
                                <polyline points="16 7 22 7 22 13"></polyline>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Daily Revenue</h3>
                        <p class="text-4xl font-bold text-green-600" id="dailyRevenue">$0.00</p>
                    </div>
                </div>

                <div class="card stat-card text-center">
                    <div class="mb-4">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-yellow-500 to-orange-600 rounded-2xl flex items-center justify-center">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M8 2v4"></path>
                                <path d="M16 2v4"></path>
                                <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                                <path d="M3 10h18"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Monthly Revenue</h3>
                        <p class="text-4xl font-bold text-yellow-600" id="monthlyRevenue">$0.00</p>
                    </div>
                </div>

                <div class="card stat-card text-center">
                    <div class="mb-4">
                        <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-purple-500 to-pink-600 rounded-2xl flex items-center justify-center">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07L9.4 6.6A5 5 0 0 0 3.34 13.5"></path>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07L14.6 17.4A5 5 0 0 0 20.66 11.5"></path>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-700 mb-1">Total Links</h3>
                        <p class="text-4xl font-bold text-purple-600" id="totalLinks">0</p>
                    </div>
                </div>
            </div>

            <div class="card text-center">
                <div class="mb-4">
                    <div class="w-16 h-16 mx-auto mb-3 bg-gradient-to-r from-red-500 to-pink-600 rounded-2xl flex items-center justify-center">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">Pending Withdrawals</h3>
                    <p class="text-4xl font-bold text-red-600" id="pendingWithdrawalsCount">0</p>
                </div>
            </div>
        </div>

        <!-- User Management Section -->
        <div id="user-management" class="content-section">
            <div class="mb-8">
                <h2 class="text-3xl font-bold mb-2 bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                    User Management
                </h2>
                <p class="text-gray-600">Manage and monitor user accounts</p>
            </div>
            
            <div class="card mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <input type="text" id="userSearchInput" placeholder="Search by email, username, or name..." class="input-field flex-1 mb-0">
                    <button id="searchUsersBtn" class="btn-primary">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="inline mr-2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="M21 21l-4.35-4.35"></path>
                        </svg>
                        Search Users
                    </button>
                </div>

    <script>
        // !!! IMPORTANT: Replace 'YOUR_VERCEL_BACKEND_API_URL' with your actual deployed Vercel backend API URL (e.g., https://your-app-name.vercel.app), ensure no trailing slash !!!
        const API_BASE_URL = 'https://linkearn-five.vercel.app'; 
        let adminLoggedIn = false; // Flag to track admin login state

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const isAdmin = localStorage.getItem('isAdmin');

            // Check if already logged in as admin
            if (token && isAdmin === 'true') {
                adminLoggedIn = true;
                showAdminPanel();
                loadSectionData('dashboard'); // Load dashboard by default
            } else {
                // Show admin login form
                document.getElementById('adminLogin').classList.add('active');
                document.getElementById('sidebar').style.display = 'none'; // Hide sidebar initially
                document.getElementById('mainContent').style.marginLeft = '0'; // No margin for login form
            }

            // Admin Login Form Submission
            document.getElementById('adminLoginForm').addEventListener('submit', async function(event) {
                event.preventDefault();
                const username = document.getElementById('adminUsername').value;
                const password = document.getElementById('adminPassword').value;
                const errorDisplay = document.getElementById('adminLoginError');

                errorDisplay.classList.add('hidden'); // Clear previous errors

                try {
                    console.log('Attempting admin login...');
                    // CORRECTED API ENDPOINT HERE
                    const response = await fetch(`${API_BASE_URL}/api/admin/login`, { 
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ username, password }),
                    });

                    const data = await response.json();
                    console.log('Admin Login API Response:', data);

                    if (response.ok) {
                        localStorage.setItem('token', data.token); // Store admin token
                        localStorage.setItem('isAdmin', true);
                        adminLoggedIn = true;
                        showMessageBox('Admin login successful! Redirecting...');
                        console.log('Admin login success, redirecting...');
                        setTimeout(() => {
                            showAdminPanel();
                            loadSectionData('dashboard');
                        }, 1000);
                    } else {
                        errorDisplay.textContent = data.message || 'Invalid username or password.';
                        errorDisplay.classList.remove('hidden');
                        showMessageBox(`Admin login failed: ${data.message || 'Invalid credentials'}`);
                        console.error('Admin login failed:', data.message);
                    }
                } catch (error) {
                    console.error('Admin login fetch error:', error);
                    errorDisplay.textContent = 'An unexpected error occurred. Please try again.';
                    errorDisplay.classList.remove('hidden');
                    showMessageBox('An unexpected error occurred. Please check console for details.');
                }
            });

            // Sidebar navigation
            const navLinks = document.querySelectorAll('.sidebar a');
            const contentSections = document.querySelectorAll('.content-section');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.id === 'adminLogoutButton') {
                        adminLogout();
                        return;
                    }

                    // Only allow navigation if logged in
                    if (!adminLoggedIn) {
                        showMessageBox('Please log in as admin first.');
                        return;
                    }

                    navLinks.forEach(nav => nav.classList.remove('active'));
                    contentSections.forEach(section => {
                        // Keep adminLogin section hidden for login form
                        if (section.id !== 'adminLogin') {
                            section.classList.remove('active');
                        }
                    });

                    this.classList.add('active');
                    const sectionId = this.dataset.section;
                    document.getElementById(sectionId).classList.add('active');

                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }

                    loadSectionData(sectionId);
                });
            });

            // Add event listeners for admin actions
            document.getElementById('searchUsersBtn').addEventListener('click', searchUsers);
            document.getElementById('saveUserBtn').addEventListener('click', saveUserDetails);
            document.getElementById('generateCodesBtn').addEventListener('click', generateUniqueCodes);
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSystemSettings);

            // Fetch initial data for sections if already logged in
            if (adminLoggedIn) {
                fetchAdminDashboardData();
                fetchUsers();
                fetchWithdrawalRequests();
                fetchUniqueCodes();
                fetchSystemSettings();
            }
        });

        function showAdminPanel() {
            document.getElementById('adminLogin').classList.remove('active'); // Hide login form
            // Also explicitly set display to none to ensure it's hidden
            document.getElementById('adminLogin').style.display = 'none'; 

            document.getElementById('sidebar').style.display = 'flex'; // Show sidebar
            // Adjust main content margin for desktop, if sidebar is visible
            if (window.innerWidth >= 768) {
                document.getElementById('mainContent').style.marginLeft = '280px';
            }
            // Ensure all other content sections are hidden, then activate dashboard
            document.querySelectorAll('.content-section').forEach(section => {
                if (section.id !== 'adminLogin') {
                    section.classList.remove('active');
                }
            });
            document.getElementById('dashboard').classList.add('active'); // Show dashboard
             // Set dashboard as active link in sidebar
            document.querySelectorAll('.sidebar a').forEach(link => {
                if (link.dataset.section === 'dashboard') {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function adminLogout() {
            localStorage.removeItem('token');
            localStorage.removeItem('isAdmin');
            adminLoggedIn = false;
            showMessageBox('Logging out...', () => {
                window.location.href = 'admin.html'; // Redirect to admin login
            });
        }

        async function loadSectionData(sectionId) {
            if (!adminLoggedIn) return; // Prevent data loading if not logged in

            if (sectionId === 'dashboard') {
                fetchAdminDashboardData();
            } else if (sectionId === 'user-management') {
                fetchUsers();
            } else if (sectionId === 'withdrawal-management') {
                fetchWithdrawalRequests();
            } else if (sectionId === 'unique-codes') {
                fetchUniqueCodes();
            } else if (sectionId === 'system-settings') {
                fetchSystemSettings();
            }
        }

        async function fetchAdminDashboardData() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('totalUsers').textContent = data.totalUsers || 0;
                    document.getElementById('dailyRevenue').textContent = `$${(data.dailyRevenue || 0).toFixed(2)}`;
                    document.getElementById('monthlyRevenue').textContent = `$${(data.monthlyRevenue || 0).toFixed(2)}`;
                    document.getElementById('totalLinks').textContent = data.totalLinks || 0;
                    document.getElementById('pendingWithdrawalsCount').textContent = data.pendingWithdrawalsCount || 0;
                } else {
                    showMessageBox(`Failed to fetch dashboard data: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error fetching admin dashboard data:', error);
                showMessageBox('Could not load dashboard data.');
            }
        }

        async function fetchUsers(searchQuery = '') {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/users${searchQuery ? `?search=${encodeURIComponent(searchQuery)}` : ''}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const tableBody = document.getElementById('userTableBody');
                tableBody.innerHTML = '';
                if (response.ok && data.users && data.users.length > 0) {
                    data.users.forEach(user => {
                        const row = tableBody.insertRow(); /* CORRECTED HERE */
                        row.insertCell().textContent = user._id;
                        row.insertCell().textContent = user.email;
                        row.insertCell().textContent = user.telegramUsername;
                        row.insertCell().textContent = `$${(user.balance || 0).toFixed(2)}`;
                        row.insertCell().textContent = user.cpmRate || 0;
                        const actionsCell = row.insertCell();
                        actionsCell.innerHTML = `
                            <button class="btn-action text-sm py-1 px-2 mr-2" onclick="editUser('${user._id}', '${user.fullName}', '${user.email}', '${user.telegramUsername}', ${user.balance}, ${user.cpmRate})">Edit</button>
                            <button class="btn-danger text-sm py-1 px-2" onclick="toggleUserBlock('${user._id}', ${user.isBlocked})">${user.isBlocked ? 'Unblock' : 'Block'}</button>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400">No users found.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching users:', error);
                showMessageBox('Could not load user data.');
            }
        }

        function searchUsers() {
            const searchQuery = document.getElementById('userSearchInput').value;
            fetchUsers(searchQuery);
        }

        function editUser(userId, fullName, email, telegramUsername, balance, cpmRate) {
            document.getElementById('editUserId').value = userId;
            document.getElementById('editFullName').value = fullName;
            document.getElementById('editEmail').value = email;
            document.getElementById('editTelegramUsername').value = telegramUsername;
            document.getElementById('editBalance').value = balance;
            document.getElementById('editCpmRate').value = cpmRate;
            document.getElementById('editUserModal').style.display = 'block';
        }

        async function saveUserDetails() {
            const userId = document.getElementById('editUserId').value;
            const fullName = document.getElementById('editFullName').value;
            const email = document.getElementById('editEmail').value;
            const telegramUsername = document.getElementById('editTelegramUsername').value;
            const balance = parseFloat(document.getElementById('editBalance').value);
            const cpmRate = parseFloat(document.getElementById('editCpmRate').value);

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ fullName, email, telegramUsername, balance, cpmRate })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessageBox('User details updated successfully!');
                    closeMessageBox();
                    fetchUsers(); // Refresh user list
                } else {
                    showMessageBox(`Failed to update user: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error saving user details:', error);
                showMessageBox('Could not save user details.');
            }
        }

        async function toggleUserBlock(userId, isBlocked) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/users/${userId}/block`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ isBlocked: !isBlocked })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessageBox(`User ${isBlocked ? 'unblocked' : 'blocked'} successfully!`);
                    fetchUsers(); // Refresh user list
                } else {
                    showMessageBox(`Failed to toggle block status: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error toggling user block:', error);
                showMessageBox('Could not toggle user block status.');
            }
        }

        async function fetchWithdrawalRequests() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/withdrawals`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const tableBody = document.getElementById('withdrawalTableBody');
                tableBody.innerHTML = '';
                if (response.ok && data.withdrawals && data.withdrawals.length > 0) {
                    data.withdrawals.forEach(req => {
                        const row = tableBody.insertRow();
                        // Assuming user email is populated from the backend for display purposes
                        row.insertCell().textContent = req.userEmail || 'N/A';
                        row.insertCell().textContent = `$${(req.amount || 0).toFixed(2)}`;
                        const usdtAddressCell = row.insertCell();
                        usdtAddressCell.innerHTML = `<span class="break-all">${req.usdtAddress}</span>`;
                        row.insertCell().textContent = new Date(req.requestDate).toLocaleDateString();
                        row.insertCell().textContent = req.status;
                        const actionsCell = row.insertCell();
                        if (req.status === 'Pending') {
                            actionsCell.innerHTML = `
                                <button class="btn-action bg-green-600 hover:bg-green-700 text-sm py-1 px-2 mr-2" onclick="processWithdrawal('${req._id}', 'Approved')">Approve</button>
                                <button class="btn-danger text-sm py-1 px-2" onclick="processWithdrawal('${req._id}', 'Rejected')">Reject</button>
                            `;
                        } else {
                            actionsCell.textContent = 'Processed';
                        }
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400">No withdrawal requests found.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching withdrawal requests:', error);
                showMessageBox('Could not load withdrawal requests.');
            }
        }

        async function processWithdrawal(requestId, status) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/withdrawals/${requestId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessageBox(`Withdrawal request ${status.toLowerCase()} successfully!`);
                    fetchWithdrawalRequests(); // Refresh list
                    fetchAdminDashboardData(); // Update pending count
                } else {
                    showMessageBox(`Failed to process withdrawal: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error processing withdrawal:', error);
                showMessageBox('Could not process withdrawal request.');
            }
        }

        async function generateUniqueCodes() {
            const numCodes = parseInt(document.getElementById('numCodesToGenerate').value);
            if (isNaN(numCodes) || numCodes < 1 || numCodes > 5) {
                showMessageBox('Please enter a number between 1 and 5.');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/unique-codes/generate`, { // Assuming a /generate endpoint
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ count: numCodes })
                });
                const data = await response.json();
                const displayArea = document.getElementById('generatedCodesDisplay');
                displayArea.innerHTML = ''; // Clear previous codes

                if (response.ok && data.codes && data.codes.length > 0) {
                    let codesHtml = '<p class="font-bold text-lg mb-2">Generated Codes:</p><ul class="list-disc list-inside">';
                    data.codes.forEach(code => {
                        codesHtml += `<li class="font-mono bg-gray-200 px-3 py-1 rounded-md inline-block mr-2 mb-2 text-gray-800">${code}</li>`;
                    });
                    codesHtml += '</ul>';
                    displayArea.innerHTML = codesHtml;
                    showMessageBox(`${data.codes.length} unique codes generated!`);
                    fetchUniqueCodes(); // Refresh active codes list
                } else {
                    showMessageBox(`Failed to generate codes: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error generating unique codes:', error);
                showMessageBox('Could not generate unique codes.');
            }
        }

        async function fetchUniqueCodes() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/unique-codes`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                const tableBody = document.getElementById('uniqueCodeTableBody');
                tableBody.innerHTML = '';
                if (response.ok && data.codes && data.codes.length > 0) {
                    data.codes.forEach(codeObj => {
                        const row = tableBody.insertRow();
                        row.insertCell().textContent = codeObj.code;
                        row.insertCell().textContent = codeObj.isActive ? 'Yes' : 'No';
                        row.insertCell().textContent = new Date(codeObj.createdDate).toLocaleDateString();
                        row.insertCell().textContent = codeObj.expiryDate ? new Date(codeObj.expiryDate).toLocaleDateString() : 'Never';
                        const actionsCell = row.insertCell();
                        actionsCell.innerHTML = `
                            <button class="btn-action text-sm py-1 px-2 mr-2" onclick="toggleUniqueCodeStatus('${codeObj._id}', ${codeObj.isActive})">${codeObj.isActive ? 'Deactivate' : 'Activate'}</button>
                            <button class="btn-danger text-sm py-1 px-2" onclick="deleteUniqueCode('${codeObj._id}')">Delete</button>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400">No unique codes found.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching unique codes:', error);
                showMessageBox('Could not load unique codes.');
            }
        }

        async function toggleUniqueCodeStatus(codeId, isActive) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/unique-codes/${codeId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ isActive: !isActive })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessageBox(`Code ${isActive ? 'deactivated' : 'activated'} successfully!`);
                    fetchUniqueCodes(); // Refresh list
                } else {
                    showMessageBox(`Failed to change code status: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error toggling unique code status:', error);
                showMessageBox('Could not change unique code status.');
            }
        }

        async function deleteUniqueCode(codeId) {
            // Implement confirmation message here
            showMessageBox(`Are you sure you want to delete this unique code?`, () => confirmDeleteUniqueCode(codeId), true);
        }

        async function confirmDeleteUniqueCode(codeId) {
            closeMessageBox(); // Close the confirmation message
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/unique-codes/${codeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    showMessageBox('Unique code deleted successfully!');
                    fetchUniqueCodes(); // Refresh list
                } else {
                    showMessageBox(`Failed to delete code: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error deleting unique code:', error);
                showMessageBox('Could not delete unique code.');
            }
        }

        async function fetchSystemSettings() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (response.ok) {
                    document.getElementById('defaultCpmRate').value = data.defaultCPM || 0;
                    document.getElementById('minWithdrawalAmount').value = data.minWithdrawal || 0;
                } else {
                    showMessageBox(`Failed to fetch settings: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error fetching system settings:', error);
                showMessageBox('Could not load system settings.');
            }
        }

        async function saveSystemSettings() {
            const defaultCPM = parseFloat(document.getElementById('defaultCpmRate').value);
            const minWithdrawal = parseFloat(document.getElementById('minWithdrawalAmount').value);

            if (isNaN(defaultCPM) || defaultCPM < 0 || isNaN(minWithdrawal) || minWithdrawal < 0) {
                showMessageBox('Please enter valid positive numbers for settings.');
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ defaultCPM, minWithdrawal })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessageBox('System settings updated successfully!');
                } else {
                    showMessageBox(`Failed to save settings: ${data.message || 'Error'}`);
                }
            } catch (error) {
                console.error('Error saving system settings:', error);
                showMessageBox('Could not save system settings.');
            }
        }

        // Message Box Functions (adapted for confirmation dialogs as well)
        function showMessageBox(message, onConfirm = null, isConfirm = false) {
            const msgBox = document.getElementById('messageBox');
            const msgText = document.getElementById('messageText');
            let okButton = msgBox.querySelector('#msgBoxOkBtn'); // Use ID for specific button
            let cancelButton = msgBox.querySelector('#msgBoxCancelBtn');

            // Clear previous buttons if they exist
            if (cancelButton) cancelButton.remove();
            if (!okButton) { // Create OK button if it doesn't exist
                okButton = document.createElement('button');
                okButton.id = 'msgBoxOkBtn';
                msgBox.appendChild(okButton);
            }

            msgText.textContent = message;

            if (isConfirm) {
                okButton.textContent = 'Confirm';
                okButton.className = 'btn-action bg-red-600 hover:bg-red-700 py-2 px-4 rounded-lg mr-2';

                cancelButton = document.createElement('button');
                cancelButton.id = 'msgBoxCancelBtn';
                cancelButton.textContent = 'Cancel';
                cancelButton.className = 'btn-action bg-gray-500 hover:bg-gray-600 py-2 px-4 rounded-lg';
                msgBox.appendChild(cancelButton);

                okButton.onclick = () => {
                    closeMessageBox();
                    if (onConfirm) onConfirm();
                };
                cancelButton.onclick = () => closeMessageBox();
            } else {
                okButton.textContent = 'OK';
                okButton.className = 'btn-action py-2 px-4 rounded-lg'; // Reset to default style
                okButton.onclick = () => closeMessageBox();
            }

            msgBox.style.display = 'block';
        }

        function closeMessageBox() {
            document.getElementById('messageBox').style.display = 'none';
            // Remove dynamically added cancel button if it exists
            const cancelButton = document.getElementById('msgBoxCancelBtn');
            if (cancelButton) cancelButton.remove();
        }
    </script>
</body>
</html>
