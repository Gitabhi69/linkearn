<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkEarn - User Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right top, #6b46c1, #805ad5, #9f7aea);
            min-height: 100vh;
            color: #ffffff;
            display: flex;
        }
        .sidebar {
            width: 250px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 1.5rem;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            border-top-right-radius: 1.5rem;
            border-bottom-right-radius: 1.5rem;
            transition: all 0.3s ease-in-out;
            transform: translateX(-100%); /* Hidden by default on mobile */
            position: fixed;
            height: 100%;
            z-index: 50;
        }
        .sidebar.active {
            transform: translateX(0%);
        }
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0%);
                position: static;
                height: auto;
            }
        }
        .sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background-color: #667eea;
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            z-index: 60;
            display: block; /* Show on mobile */
        }
        @media (min-width: 768px) {
            .sidebar-toggle {
                display: none; /* Hide on desktop */
            }
        }
        .sidebar a {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.75rem;
            color: #e2e8f0;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
        .sidebar a:hover, .sidebar a.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
            transition: margin-left 0.3s ease-in-out;
            margin-left: 0; /* No margin on mobile */
        }
        @media (min-width: 768px) {
            .main-content {
                margin-left: 250px; /* Adjust for sidebar width on desktop */
            }
        }
        .content-section {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
            margin-bottom: 2rem;
            display: none; /* Hidden by default, shown by JS */
        }
        .content-section.active {
            display: block;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.15);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
        }
        .btn-action {
            background: linear-gradient(to right, #4c51bf, #667eea);
            color: white;
            padding: 0.6rem 1.2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 1.25rem;
            border-radius: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            outline: none;
            transition: border-color 0.2s ease-in-out;
        }
        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        .input-field:focus {
            border-color: #a78bfa; /* Focus color */
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none; /* Hidden by default */
        }
        .message-box button {
            background-color: #667eea;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        th {
            background-color: rgba(255, 255, 255, 0.1);
            font-weight: 700;
        }
        .text-gray-400 {
            color: #a0aec0;
        }
        .icon-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            margin: 0 auto 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .icon-container svg {
            width: 32px;
            height: 32px;
            color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="sidebar-toggle" onclick="toggleSidebar()">â˜°</div>

    <div class="sidebar" id="sidebar">
        <h2 class="text-3xl font-bold mb-8 text-center">LinkEarn</h2>
        <nav class="flex flex-col">
            <a href="#" class="active" data-section="statistics">Statistics</a>
            <a href="#" data-section="api">API</a>
            <a href="#" data-section="payment">Payment</a>
            <a href="#" data-section="earnings">Earnings</a>
            <a href="#" data-section="recent-links">Recent Links</a>
            <a href="#" data-section="test-link">Test Link</a>
            <a href="#" data-section="help">Help</a>
            <a href="#" id="logoutButton" class="mt-auto text-red-300 hover:text-red-500 hover:bg-transparent">Logout</a>
        </nav>
    </div>

    <div class="main-content" id="mainContent">
        <h1 class="text-4xl font-bold mb-8">User Dashboard</h1>

        <!-- Statistics Section -->
        <div id="statistics" class="content-section active">
            <h2 class="text-3xl font-bold mb-6">Statistics</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <div class="card text-center">
                    <div class="icon-container">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-dollar-sign"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Today's Revenue (IST)</h3>
                    <p class="text-4xl font-bold text-green-400" id="todayRevenue">$0.00</p>
                </div>
                <div class="card text-center">
                    <div class="icon-container">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-wallet"><path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h12a2 2 0 0 1 0 4H5a2 2 0 0 0 0 4h12a2 2 0 0 0 2-2v-3"/><path d="M10 12h.01"/></svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Current Balance</h3>
                    <p class="text-4xl font-bold text-blue-400" id="currentBalance">$0.00</p>
                </div>
                <div class="card text-center">
                    <div class="icon-container">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Total Views</h3>
                    <p class="text-4xl font-bold" id="totalViews">0</p>
                </div>
            </div>
            <div class="card p-6">
                <h3 class="text-xl font-semibold mb-4">Your User ID</h3>
                <p id="userIdDisplay" class="text-lg break-all text-gray-300">Loading User ID...</p>
            </div>
        </div>

        <!-- API Section -->
        <div id="api" class="content-section">
            <h2 class="text-3xl font-bold mb-6">API Integration</h2>
            <div class="card p-6">
                <h3 class="text-xl font-semibold mb-4">Generate API Key</h3>
                <p class="text-gray-300 mb-4">
                    Click the button below to generate a one-time API key. Use this key in Telegram to connect your bot.
                </p>
                <p class="text-sm text-gray-400 mb-6">
                    Instructions: Go to <span id="botUsernameDisplay" class="font-bold">@yourbotusername</span> in Telegram, send <code class="bg-gray-700 rounded px-2 py-1">/start</code>, and then paste this API key.
                </p>
                <button id="generateApiKeyBtn" class="btn-action mb-4">Generate New API Key</button>
                <div id="apiKeyContainer" class="hidden">
                    <p class="text-lg font-mono bg-gray-700 p-3 rounded-lg flex justify-between items-center break-all">
                        <span id="apiKeyDisplay"></span>
                        <button id="copyApiKeyBtn" class="ml-4 btn-action bg-blue-600 hover:bg-blue-700">Copy</button>
                    </p>
                    <p class="text-sm text-gray-400 mt-2">This key is for one-time use and will expire shortly.</p>
                </div>
            </div>
        </div>

        <!-- Payment Section -->
        <div id="payment" class="content-section">
            <h2 class="text-3xl font-bold mb-6">Payment Settings</h2>
            <div class="card p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4">USDT BEP20 Wallet Address</h3>
                <input type="text" id="usdtAddress" placeholder="Enter your USDT BEP20 address" class="input-field mb-4">
                <button id="saveUsdtAddressBtn" class="btn-action">Save Address</button>
            </div>
            <div class="card p-6">
                <h3 class="text-xl font-semibold mb-4">Withdraw Funds</h3>
                <p class="text-gray-300 mb-4">Current Balance: <span class="font-bold text-blue-400" id="withdrawalBalance">$0.00</span></p>
                <p class="text-sm text-gray-400 mb-4">Minimum withdrawal amount: <span id="minWithdrawalDisplay">$100</span> USD</p>
                <input type="number" id="withdrawalAmount" placeholder="Amount to withdraw (USD)" class="input-field mb-4" min="100">
                <button id="requestWithdrawalBtn" class="btn-action">Request Withdrawal</button>
            </div>
        </div>

        <!-- Earnings Section -->
        <div id="earnings" class="content-section">
            <h2 class="text-3xl font-bold mb-6">Earnings History</h2>
            <div class="card p-6">
                <h3 class="text-xl font-semibold mb-4">Last 10 Days Earnings</h3>
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Earnings</th>
                            <th>Views</th>
                        </tr>
                    </thead>
                    <tbody id="earningsHistoryTableBody">
                        <!-- Earnings data will be populated here -->
                    </tbody>
                </table>
                <p class="text-xl font-bold mt-6">Total Earnings: <span class="text-green-400" id="totalEarningsSummary">$0.00</span></p>
            </div>
        </div>

        <!-- Recent Links Section -->
        <div id="recent-links" class="content-section">
            <h2 class="text-3xl font-bold mb-6">Recent Links</h2>
            <div class="card p-6">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th>Link</th>
                            <th>Views</th>
                            <th>Date Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="recentLinksTableBody">
                        <!-- Recent links data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Test Link Section -->
        <div id="test-link" class="content-section">
            <h2 class="text-3xl font-bold mb-6">Test Link Generation</h2>
            <div class="card p-6">
                <p class="text-gray-300 mb-4">
                    Generate a test link that doesn't count views or affect your earnings. Useful for testing media delivery.
                </p>
                <button id="generateTestLinkBtn" class="btn-action">Generate Test Link</button>
                <div id="testLinkContainer" class="hidden mt-4">
                    <p class="text-lg font-mono bg-gray-700 p-3 rounded-lg flex justify-between items-center break-all">
                        <span id="testLinkDisplay"></span>
                        <button id="copyTestLinkBtn" class="ml-4 btn-action bg-blue-600 hover:bg-blue-700">Copy</button>
                    </p>
                    <p class="text-sm text-gray-400 mt-2">This is a test link and will not contribute to your earnings.</p>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div id="help" class="content-section">
            <h2 class="text-3xl font-bold mb-6">Help & Support</h2>
            <div class="card p-6">
                <h3 class="text-xl font-semibold mb-4">Frequently Asked Questions</h3>
                <ul class="list-disc list-inside space-y-2 text-gray-300">
                    <li>How do I connect my Telegram bot? <br>
                        <span class="text-sm text-gray-400">Go to the API section, generate a key, and send <code class="bg-gray-700 rounded px-1">/start</code> followed by the key to <span class="font-bold" id="faqBotUsername">@yourbotusername</span>.</span></li>
                    <li>What is the minimum withdrawal amount? <br>
                        <span class="text-sm text-gray-400">The minimum withdrawal is <span id="faqMinWithdrawal">$100 USD</span>.</span></li>
                    <li>How often are earnings updated? <br>
                        <span class="text-sm text-gray-400">Your balance is updated in real-time. Daily earnings are calculated in Indian Standard Time (IST).</span></li>
                    <li>Can I delete my generated links? <br>
                        <span class="text-sm text-gray-400">Yes, you can delete your own links from the "Recent Links" section.</span></li>
                    <li>What if my media isn't delivered? <br>
                        <span class="text-sm text-gray-400">Ensure your Telegram app is updated. For persistent issues, contact support.</span></li>
                </ul>
                <h3 class="text-xl font-semibold mt-8 mb-4">Contact Support</h3>
                <p class="text-gray-300">
                    For further assistance, please contact our support bot: <a href="https://t.me/your_help_bot" target="_blank" class="text-blue-300 hover:underline">@helpbot</a>
                </p>
            </div>
        </div>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box">
        <p id="messageText"></p>
        <button onclick="closeMessageBox()">OK</button>
    </div>

    <script>
        const API_BASE_URL = 'https://linkearn-b6608fc9771a.herokuapp.com'; // !!! IMPORTANT: Replace with your deployed Heroku backend URL !!!
        const TELEGRAM_BOT_USERNAME = '@GoogleErrorBot'; // !!! IMPORTANT: Replace with your actual Telegram bot username !!!
        const TELEGRAM_HELP_BOT_USERNAME = '@helpbot'; // !!! IMPORTANT: Replace with your actual Telegram help bot username !!!

        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('userId');
            const userEmail = localStorage.getItem('userEmail');
            const isAdmin = localStorage.getItem('isAdmin');

            // Redirect if not logged in or if admin tries to access user dashboard
            if (!token || !userId) {
                window.location.href = 'login.html';
                return;
            }
            if (isAdmin === 'true') {
                window.location.href = 'admin.html'; // Admins should go to admin panel
                return;
            }

            // Display user ID
            document.getElementById('userIdDisplay').textContent = `User ID: ${userId}`;

            // Update bot usernames in help and API sections
            document.getElementById('botUsernameDisplay').textContent = TELEGRAM_BOT_USERNAME;
            document.getElementById('faqBotUsername').textContent = TELEGRAM_BOT_USERNAME;
            document.getElementById('help').querySelector('a').href = `https://t.me/${TELEGRAM_HELP_BOT_USERNAME}`;
            document.getElementById('help').querySelector('a').textContent = TELEGRAM_HELP_BOT_USERNAME;


            // Sidebar functionality
            const navLinks = document.querySelectorAll('.sidebar a');
            const contentSections = document.querySelectorAll('.content-section');
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (this.id === 'logoutButton') {
                        logout();
                        return;
                    }

                    // Remove active class from all links and sections
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    contentSections.forEach(section => section.classList.remove('active'));

                    // Add active class to clicked link
                    this.classList.add('active');

                    // Show corresponding content section
                    const sectionId = this.dataset.section;
                    document.getElementById(sectionId).classList.add('active');

                    // Hide sidebar on mobile after selection
                    if (window.innerWidth < 768) {
                        sidebar.classList.remove('active');
                    }

                    // Load data for the selected section
                    loadSectionData(sectionId);
                });
            });

            // Initial load of statistics
            loadSectionData('statistics');

            // Add event listeners for buttons
            document.getElementById('generateApiKeyBtn').addEventListener('click', generateApiKey);
            document.getElementById('copyApiKeyBtn').addEventListener('click', copyApiKey);
            document.getElementById('saveUsdtAddressBtn').addEventListener('click', saveUsdtAddress);
            document.getElementById('requestWithdrawalBtn').addEventListener('click', requestWithdrawal);
            document.getElementById('generateTestLinkBtn').addEventListener('click', generateTestLink);
            document.getElementById('copyTestLinkBtn').addEventListener('click', copyTestLink);

            // Fetch initial user stats on page load
            fetchUserStats();
            fetchEarningsHistory();
            fetchRecentLinks();
            fetchAdminSettings(); // To get min withdrawal amount for display

            function logout() {
                localStorage.removeItem('token');
                localStorage.removeItem('userId');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('isAdmin');
                showMessage('Logging out...', () => {
                    window.location.href = 'login.html';
                });
            }

            function toggleSidebar() {
                sidebar.classList.toggle('active');
            }

            async function loadSectionData(sectionId) {
                // This function would trigger data fetches specific to the section
                // For now, it just shows the section and fetches main stats on load
                if (sectionId === 'statistics') {
                    fetchUserStats();
                } else if (sectionId === 'earnings') {
                    fetchEarningsHistory();
                } else if (sectionId === 'recent-links') {
                    fetchRecentLinks();
                } else if (sectionId === 'api') {
                    // Reset API key display
                    document.getElementById('apiKeyContainer').classList.add('hidden');
                    document.getElementById('apiKeyDisplay').textContent = '';
                }
            }

            async function fetchUserStats() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/user-stats`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        document.getElementById('todayRevenue').textContent = `$${(data.todayRevenue || 0).toFixed(2)}`;
                        document.getElementById('currentBalance').textContent = `$${(data.currentBalance || 0).toFixed(2)}`;
                        document.getElementById('withdrawalBalance').textContent = `$${(data.currentBalance || 0).toFixed(2)}`;
                        document.getElementById('totalViews').textContent = data.totalViews || 0;
                        document.getElementById('usdtAddress').value = data.usdtAddress || '';
                        document.getElementById('totalEarningsSummary').textContent = `$${(data.totalEarnings || 0).toFixed(2)}`;
                    } else {
                        showMessage(`Failed to fetch stats: ${data.message || 'Error'}`);
                    }
                } catch (error) {
                    console.error('Error fetching user stats:', error);
                    showMessage('Could not load user statistics.');
                }
            }

            async function generateApiKey() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/user/api-key`, {
                        method: 'GET', // Or POST if API key generation is a POST request on backend
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        document.getElementById('apiKeyDisplay').textContent = data.apiKey;
                        document.getElementById('apiKeyContainer').classList.remove('hidden');
                        showMessage('API Key generated successfully! It will expire shortly.');
                    } else {
                        showMessage(`Failed to generate API Key: ${data.message || 'Error'}`);
                    }
                } catch (error) {
                    console.error('Error generating API key:', error);
                    showMessage('Could not generate API key.');
                }
            }

            function copyApiKey() {
                const apiKeyText = document.getElementById('apiKeyDisplay').textContent;
                copyToClipboard(apiKeyText, 'API Key copied to clipboard!');
            }

            async function saveUsdtAddress() {
                const usdtAddress = document.getElementById('usdtAddress').value;
                if (!usdtAddress) {
                    showMessage('Please enter a USDT BEP20 address.');
                    return;
                }
                // Basic validation for BEP20 (starts with 0x, length of 42 chars)
                if (!/^0x[a-fA-F0-9]{40}$/.test(usdtAddress)) {
                    showMessage('Invalid USDT BEP20 address format. It should start with "0x" and be 42 characters long.');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/user/payment`, {
                        method: 'POST', // or PUT if updating
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ usdtAddress })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessage('USDT address saved successfully!');
                    } else {
                        showMessage(`Failed to save address: ${data.message || 'Error'}`);
                    }
                } catch (error) {
                    console.error('Error saving USDT address:', error);
                    showMessage('Could not save USDT address.');
                }
            }

            async function requestWithdrawal() {
                const amount = parseFloat(document.getElementById('withdrawalAmount').value);
                const currentBalance = parseFloat(document.getElementById('withdrawalBalance').textContent.replace('$', ''));
                const minWithdrawal = parseFloat(document.getElementById('minWithdrawalDisplay').textContent.replace('$', ''));
                const usdtAddress = document.getElementById('usdtAddress').value;

                if (isNaN(amount) || amount <= 0) {
                    showMessage('Please enter a valid withdrawal amount.');
                    return;
                }
                if (amount < minWithdrawal) {
                    showMessage(`Withdrawal amount must be at least $${minWithdrawal}.`);
                    return;
                }
                if (amount > currentBalance) {
                    showMessage('Withdrawal amount exceeds your current balance.');
                    return;
                }
                if (!usdtAddress || !/^0x[a-fA-F0-9]{40}$/.test(usdtAddress)) {
                    showMessage('Please save a valid USDT BEP20 address in the section above before requesting withdrawal.');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/user/withdraw`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ amount, usdtAddress })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessage('Withdrawal request submitted successfully! It is pending admin approval.');
                        document.getElementById('withdrawalAmount').value = ''; // Clear input
                        fetchUserStats(); // Update balance
                    } else {
                        showMessage(`Withdrawal failed: ${data.message || 'Error'}`);
                    }
                } catch (error) {
                    console.error('Error requesting withdrawal:', error);
                    showMessage('Could not submit withdrawal request.');
                }
            }

            async function fetchEarningsHistory() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/user/earnings-history`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const tableBody = document.getElementById('earningsHistoryTableBody');
                        tableBody.innerHTML = ''; // Clear existing rows
                        if (data.earnings && data.earnings.length > 0) {
                            data.earnings.forEach(earning => {
                                const row = tableBody.insertRow();
                                row.insertCell().textContent = new Date(earning.date).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                                row.insertCell().textContent = `$${(earning.amount || 0).toFixed(2)}`;
                                row.insertCell().textContent = earning.views || 0; // Assuming views come with earnings history
                            });
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-400">No earnings history found.</td></tr>';
                        }
                    } else {
                        showMessage(`Failed to fetch earnings history: ${data.message || 'Error'}`);
                    }
                } catch (error) {
                    console.error('Error fetching earnings history:', error);
                    showMessage('Could not load earnings history.');
                }
            }

            async function fetchRecentLinks() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/user/recent-links`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    if (response.ok) {
                        const tableBody = document.getElementById('recentLinksTableBody');
                        tableBody.innerHTML = ''; // Clear existing rows
                        if (data.links && data.links.length > 0) {
                            data.links.forEach(link => {
                                const row = tableBody.insertRow();
                                const linkCell = row.insertCell();
                                linkCell.innerHTML = `<a href="${link.generatedLink}" target="_blank" class="text-blue-300 hover:underline break-all">${link.generatedLink}</a>`;
                                row.insertCell().textContent = link.viewCount || 0;
                                row.insertCell().textContent = new Date(link.createdDate).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                                const actionCell = row.insertCell();
                                const deleteButton = document.createElement('button');
                                deleteButton.textContent = 'Delete';
                                deleteButton.className = 'btn-action bg-red-600 hover:bg-red-700 text-sm py-1 px-2';
                                deleteButton.onclick = () => deleteLink(link._id);
                                actionCell.appendChild(deleteButton);
                            });
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-400">No links generated yet.</td></tr>';
                        }
                    } else {
                        showMessage(`Failed to fetch recent links: ${data.message || 'Error'}`);
                    }
                } catch (error) {
                    console.error('Error fetching recent links:', error);
                    showMessage('Could not load recent links.');
                }
            }

            async function deleteLink(linkId) {
                // Implement confirmation message here
                showMessageBox(`Are you sure you want to delete this link? This action cannot be undone.`, () => confirmDelete(linkId), true);
            }

            async function confirmDelete(linkId) {
                closeMessageBox(); // Close the confirmation message
                try {
                    const response = await fetch(`${API_BASE_URL}/api/user/links/${linkId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();
                    if (response.ok) {
                        showMessage('Link deleted successfully!');
                        fetchRecentLinks(); // Refresh the list
                    } else {
                        showMessage(`Failed to delete link: ${data.message || 'Error'}`);
                    }
                } catch (error) {
                    console.error('Error deleting link:', error);
                    showMessage('Could not delete link.');
                }
            }


            async function generateTestLink() {
                // This would typically simulate sending media to the bot or triggering a backend endpoint
                // For now, it just shows a placeholder link
                const placeholderUniqueId = 'TEST' + Math.random().toString(36).substring(2, 7).toUpperCase();
                const testLink = `https://t.me/${TELEGRAM_BOT_USERNAME}/videos?startapp=recieve_${placeholderUniqueId}`;

                document.getElementById('testLinkDisplay').textContent = testLink;
                document.getElementById('testLinkContainer').classList.remove('hidden');
                showMessage('Test link generated! This link will not count views.');
            }

            function copyTestLink() {
                const testLinkText = document.getElementById('testLinkDisplay').textContent;
                copyToClipboard(testLinkText, 'Test link copied to clipboard!');
            }

            // Generic copy to clipboard function
            function copyToClipboard(text, successMessage) {
                const tempInput = document.createElement('textarea');
                tempInput.value = text;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showMessage(successMessage);
                } catch (err) {
                    showMessage('Failed to copy. Please copy manually.');
                    console.error('Failed to copy text: ', err);
                }
                document.body.removeChild(tempInput);
            }

            function showMessageBox(message, onConfirm = null, isConfirm = false) {
                const msgBox = document.getElementById('messageBox');
                const msgText = document.getElementById('messageText');
                const okButton = msgBox.querySelector('button');

                msgText.textContent = message;
                okButton.onclick = () => {
                    closeMessageBox();
                    if (onConfirm && !isConfirm) { // Only execute onConfirm if it's not a confirmation prompt
                        onConfirm();
                    }
                };

                // Add a "Cancel" button if it's a confirmation prompt
                if (isConfirm) {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = 'Cancel';
                    cancelButton.className = 'btn-action bg-gray-500 hover:bg-gray-600 text-sm py-1 px-2 ml-2';
                    cancelButton.onclick = () => closeMessageBox();
                    msgBox.appendChild(cancelButton);
                    okButton.textContent = 'Confirm';
                    okButton.onclick = () => onConfirm(); // Set Confirm button's action
                } else {
                    if (msgBox.querySelector('.btn-action.bg-gray-500')) { // Remove cancel button if present
                        msgBox.querySelector('.btn-action.bg-gray-500').remove();
                    }
                    okButton.textContent = 'OK';
                }

                msgBox.style.display = 'block';
            }

            function closeMessageBox() {
                document.getElementById('messageBox').style.display = 'none';
                // Clean up any dynamically added cancel button
                const msgBox = document.getElementById('messageBox');
                const cancelButton = msgBox.querySelector('.btn-action.bg-gray-500');
                if (cancelButton) {
                    cancelButton.remove();
                }
            }

            async function fetchAdminSettings() {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/admin/settings`, { // This endpoint might need to be public or accessed differently if user needs global settings
                        headers: {
                            'Authorization': `Bearer ${token}` // Assuming some settings are publicly accessible or a limited token
                        }
                    });
                    const data = await response.json();
                    if (response.ok && data.minWithdrawal) {
                        document.getElementById('minWithdrawalDisplay').textContent = `$${data.minWithdrawal}`;
                        document.getElementById('faqMinWithdrawal').textContent = `$${data.minWithdrawal} USD`;
                    }
                } catch (error) {
                    console.error('Error fetching admin settings for min withdrawal:', error);
                    // Default to $100 if fetch fails
                    document.getElementById('minWithdrawalDisplay').textContent = `$100`;
                    document.getElementById('faqMinWithdrawal').textContent = `$100 USD`;
                }
            }
        });
    </script>
</body>
</html>
